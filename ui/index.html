<!DOCTYPE html>
<!--
A Handlebars template for the ArtisanUI web app. Includes
- the core styles and logic (`/__artisan-ui/*`),
- their (non-bundled) dependencies (`/__deps/*`),
- the user-defined extension (`/__extension/*`),
- its (non-bundled) dependencies (`/__extension/*` / remote urls), and
- hot-reloading logic.

Expects to be called with an object with the following properties:
- extension (Boolean): Whether the user defined an ArtisanUI extension
- styles (string[]?): URLs of the CSS files required by the extension
- scripts (string[]?): URLs of the Javascript files required by the extension
- timestamps ({ extension: number, prelude: number }?): Last edit times of the
    extension and its prelude (the first-token comment specifying the
    extension's assumptions about its environment), to compare against for
    autorefreshing
-->

<head>
    <!-- Basic metadata -->
    <meta charset="utf-8">
    <title>ArtisanUI</title>

    <!-- Core styles -->
    <link rel="stylesheet" href="/__artisan-ui/index.css">

    {{#if extension}}
    <!-- Styles required by the extension -->
    {{#each styles}}
    <link rel="stylesheet" href="{{this}}">
    {{/each}}
    {{/if}}
</head>

<body>
    <!-- Mount point for the root React element -->
    <div id="__artisan-ui-root"></div>

    <!-- Core scripts -->
    <script src="/__artisan-ui/deps/react/umd/react.development.js"></script>
    <script src="/__artisan-ui/deps/react-dom/umd/react-dom.development.js"></script>
    <script src="/__artisan-ui/deps/numjs/dist/numjs.min.js"></script>
    <script src="/__artisan-ui/dist/index.js"></script>
    <script> ArtisanUI.render() </script>

    {{#if extension}}
    <!-- Scripts required by the extension -->
    {{#each scripts}}
    <script src="{{this}}"></script>
    {{/each}}

    <!-- The extension script bundle, wrapped to facilitate hot-reloading -->
    <div id="__extension-container">
        <script src="/__extension/index.js"></script>
    </div>
    <script> ArtisanUI.render(Extension.default) </script>

    <!-- Autoupdater (Δcore -> hard refresh; Δext -> hot reload) -->
    <script>
        let timestamps = {
            prelude: JSON.parse('{{timestamps.prelude}}'),
            extension: JSON.parse('{{timestamps.extension}}')
        }
        const checker = setInterval(checkForUpdates, 100)

        function checkForUpdates() {
            fetch('/__extension/timestamps.json')
            .then(res => res.json())
            .then(t => {
                if (t.prelude > timestamps.prelude)
                    location.reload()
                else if (t.extension > timestamps.extension)
                    updateExtension()
                timestamps = t
            })
            .catch(() => {
                clearInterval(checker)
            })
        }

        function updateExtension() {
            const script = document.createElement('script')
            script.src = '/__extension/index.js'
            script.onload = () => ArtisanUI.render(Extension.default)
            const container = document.getElementById('__extension-container')
            container.removeChild(container.children[0])
            container.appendChild(script)
        }
    </script>
    {{/if}}
</body>
